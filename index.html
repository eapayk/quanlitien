<!DOCTYPE html>
<html lang="vi">
<head>
    <!-- Meta tags cơ bản -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Chi Tiêu - Pro Vip </title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#2c3e50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="QL Chi Tiêu">
    <meta name="application-name" content="QL Chi Tiêu">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#2c3e50">
    <meta name="msapplication-tap-highlight" content="no">
    
    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Icons -->
    <link rel="icon" href="icon-192x192.png" type="image/png">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #16ec45 0%, #c3cfe2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* Authentication Container */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 80vh;
        }
        
        .auth-box {
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            padding: 40px;
            width: 100%;
            max-width: 450px;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .auth-box h2 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .auth-box h2 i {
            color: #3498db;
        }
        
        .auth-form .form-group {
            margin-bottom: 20px;
        }
        
        .auth-form label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 0.95rem;
        }
        
        .auth-form input {
            width: 100%;
            padding: 14px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .auth-form input:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .auth-form .password-input {
            position: relative;
        }
        
        .auth-form .toggle-password {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #7f8c8d;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .auth-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .auth-button:hover {
            background: linear-gradient(135deg, #2980b9, #1c6ea4);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        
        .auth-button.register {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }
        
        .auth-button.register:hover {
            background: linear-gradient(135deg, #27ae60, #219653);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
        }
        
        .auth-links {
            text-align: center;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }
        
        .auth-links a {
            color: #3498db;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s;
        }
        
        .auth-links a:hover {
            color: #2980b9;
            text-decoration: underline;
        }
        
        .auth-message {
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
            font-size: 0.9rem;
            display: none;
        }
        
        .auth-message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }
        
        .auth-message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        
        /* User Menu */
        .user-menu {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .user-button {
            background: white;
            border: none;
            border-radius: 50px;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .user-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }
        
        .user-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3498db, #2ecc71);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.1rem;
            overflow: hidden;
        }
        
        .user-avatar-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            min-width: 200px;
            margin-top: 10px;
            display: none;
            animation: fadeIn 0.3s ease;
            overflow: hidden;
            z-index: 1001;
        }
        
        .user-dropdown.show {
            display: block;
        }
        
        .user-info {
            padding: 20px;
            border-bottom: 1px solid #eee;
            text-align: center;
        }
        
        .user-info .user-avatar {
            margin: 0 auto 10px;
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
        }
        
        .user-info h4 {
            margin-bottom: 5px;
            color: #2c3e50;
        }
        
        .user-info p {
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px 20px;
            color: #555;
            text-decoration: none;
            transition: background-color 0.3s;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 1rem;
        }
        
        .dropdown-item:hover {
            background-color: #f8f9fa;
            color: #3498db;
        }
        
        .dropdown-item.logout {
            color: #e74c3c;
            border-top: 1px solid #eee;
        }
        
        .dropdown-item.logout:hover {
            background-color: #ffeaea;
        }
        
        /* Account Management Page */
        .account-management {
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 40px;
            margin: 20px auto;
            max-width: 800px;
            animation: fadeIn 0.5s ease;
        }
        
        .account-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .account-header h2 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2rem;
        }
        
        .account-header p {
            color: #7f8c8d;
            font-size: 1.1rem;
        }
        
        .account-sections {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        
        .account-section {
            background-color: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            border: 1px solid #e0e0e0;
        }
        
        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 1.3rem;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }
        
        .profile-picture-container {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .profile-picture {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin: 0 auto 20px;
            position: relative;
            overflow: hidden;
            border: 5px solid white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .profile-picture-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .profile-picture-placeholder {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #3498db, #2ecc71);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 3rem;
            font-weight: bold;
        }
        
        .profile-picture-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }
        
        .profile-picture-actions button {
            padding: 10px 20px;
            font-size: 0.9rem;
        }
        
        .account-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .account-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }
        
        .btn-secondary {
            background-color: #95a5a6;
        }
        
        .btn-secondary:hover {
            background-color: #7f8c8d;
        }
        
        .btn-danger {
            background-color: #e74c3c;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .delete-account {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .delete-account h4 {
            color: #721c24;
            margin-bottom: 10px;
        }
        
        .delete-account p {
            color: #721c24;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }
        
        /* Hide main app when not logged in */
        .main-app {
            display: none;
        }
        
        /* Back to App Button */
        .back-to-app {
            position: fixed;
            top: 20px;
            left: 20px;
            background: white;
            border: none;
            border-radius: 50px;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            color: #2c3e50;
            z-index: 1000;
        }
        
        .back-to-app:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
            background-color: #3498db;
            color: white;
        }
        
        /* PWA Install Button */
        .install-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 12px 24px;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
            cursor: pointer;
            z-index: 1000;
            display: none;
            align-items: center;
            gap: 8px;
        }
        
        .install-button.show {
            display: flex;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        /* Offline Indicator */
        .offline-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #e74c3c;
            color: white;
            text-align: center;
            padding: 10px;
            font-weight: bold;
            z-index: 1001;
            display: none;
        }
        
        .offline-indicator.show {
            display: block;
            animation: slideDown 0.3s;
        }
        
        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background-color: #2c3e50;
            color: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .app-description {
            font-size: 0.95rem;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        .pwa-badge {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-left: 10px;
            vertical-align: middle;
        }
        
        /* SUMMARY SECTION */
        .summary-section {
            margin-bottom: 30px;
        }
        
        .summary-cards {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background-color: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            flex: 1;
            min-width: 250px;
            text-align: center;
            transition: transform 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card.limit {
            border-top: 5px solid #3498db;
        }
        
        .card.spent {
            border-top: 5px solid #e74c3c;
        }
        
        .card.remaining {
            border-top: 5px solid #2ecc71;
        }
        
        .card h3 {
            font-size: 1.1rem;
            margin-bottom: 10px;
            color: #555;
        }
        
        .card .amount {
            font-size: 2rem;
            font-weight: bold;
        }
        
        .limit-amount {
            color: #3498db;
        }
        
        .spent-amount {
            color: #e74c3c;
        }
        
        .remaining-amount {
            color: #2ecc71;
        }
        
        /* FUNCTIONS SECTION */
        .functions-section {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
            overflow: hidden;
        }
        
        .tab-header {
            display: flex;
            background-color: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .tab-button {
            flex: 1;
            padding: 18px 20px;
            background: none;
            border: none;
            font-size: 1.1rem;
            font-weight: 600;
            color: #555;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            border-bottom: 3px solid transparent;
        }
        
        .tab-button:hover {
            background-color: #e9ecef;
            color: #3498db;
        }
        
        .tab-button.active {
            color: #3498db;
            border-bottom: 3px solid #3498db;
            background-color: white;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .input-box {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 0;
        }
        
        .input-box h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
            font-size: 1.4rem;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        input, select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus {
            border-color: #3498db;
            outline: none;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 14px 25px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        .btn-add {
            background-color: #2ecc71;
        }
        
        .btn-add:hover {
            background-color: #27ae60;
        }
        
        /* EXPENSES SECTION */
        .expenses-section {
            background-color: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .section-header h2 {
            color: #2c3e50;
            font-size: 1.6rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .expenses-count {
            background-color: #3498db;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .expenses-table-container {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }
        
        .expenses-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        .expenses-table thead {
            background-color: #2c3e50;
        }
        
        .expenses-table th {
            padding: 16px 20px;
            text-align: left;
            color: white;
            font-weight: 600;
            font-size: 1rem;
        }
        
        .expenses-table tbody tr {
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        }
        
        .expenses-table tbody tr:hover {
            background-color: #f9f9f9;
        }
        
        .expenses-table td {
            padding: 16px 20px;
            color: #555;
        }
        
        .expenses-table .category-cell {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .category-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #ecf0f1;
            color: #2c3e50;
            font-size: 1rem;
        }
        
        .amount-cell {
            font-weight: 600;
            color: #e74c3c;
        }
        
        .date-cell {
            color: #7f8c8d;
        }
        
        .actions {
            display: flex;
            gap: 8px;
        }
        
        .btn-edit, .btn-delete {
            padding: 8px 16px;
            font-size: 0.9rem;
            border-radius: 6px;
        }
        
        .btn-edit {
            background-color: #f39c12;
        }
        
        .btn-edit:hover {
            background-color: #d68910;
        }
        
        .btn-delete {
            background-color: #e74c3c;
        }
        
        .btn-delete:hover {
            background-color: #c0392b;
        }
        
        .no-expenses {
            text-align: center;
            padding: 40px 20px;
            color: #7f8c8d;
        }
        
        .no-expenses i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #bdc3c7;
        }
        
        .no-expenses p {
            font-size: 1.1rem;
        }
        
        /* CATEGORIES SECTION */
        .edit-categories {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
        }
        
        .categories-list {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 20px;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .category-tag {
            background-color: white;
            padding: 10px 20px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
        }
        
        .category-tag i {
            cursor: pointer;
            color: #95a5a6;
            transition: color 0.3s;
        }
        
        .category-tag i:hover {
            color: #e74c3c;
        }
        
        .add-category {
            display: flex;
            gap: 10px;
        }
        
        .add-category input {
            flex: 1;
        }
        
        /* NOTIFICATION */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s, transform 0.3s;
            max-width: 300px;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .notification.success {
            background-color: #2ecc71;
        }
        
        .notification.error {
            background-color: #e74c3c;
        }
        
        .notification.warning {
            background-color: #f39c12;
        }
        
        .notification.info {
            background-color: #3498db;
        }
        
        /* PWA STATUS */
        .pwa-status {
            text-align: center;
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-size: 0.9rem;
            color: #7f8c8d;
            border-left: 4px solid #3498db;
        }
        
        /* FOOTER */
        footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        /* RESPONSIVE */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .card {
                min-width: 100%;
                padding: 20px;
            }
            
            .card .amount {
                font-size: 1.8rem;
            }
            
            .auth-box {
                padding: 30px 20px;
                margin: 0 10px;
            }
            
            .user-menu {
                position: relative;
                top: 0;
                right: 0;
                margin-bottom: 20px;
                display: flex;
                justify-content: flex-end;
            }
            
            .user-button span {
                display: none;
            }
            
            .account-management {
                padding: 20px;
                margin: 10px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .profile-picture {
                width: 120px;
                height: 120px;
            }
            
            .tab-header {
                flex-wrap: wrap;
            }
            
            .tab-button {
                padding: 15px 10px;
                font-size: 1rem;
            }
            
            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .expenses-table th,
            .expenses-table td {
                padding: 12px 10px;
                font-size: 0.9rem;
            }
            
            .actions {
                flex-direction: column;
            }
            
            .btn-edit, .btn-delete {
                width: 100%;
            }
            
            .add-category {
                flex-direction: column;
            }
            
            .install-button {
                bottom: 70px;
                right: 10px;
                font-size: 0.9rem;
                padding: 10px 20px;
            }
        }
        
        @media (display-mode: standalone) {
            body {
                padding-top: calc(20px + env(safe-area-inset-top));
            }
            
            header {
                padding-top: calc(20px + env(safe-area-inset-top));
            }
            
            .install-button {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <!-- Offline Indicator -->
    <div class="offline-indicator" id="offlineIndicator">
        <i class="fas fa-wifi-slash"></i> Đang offline - Dữ liệu sẽ được lưu tạm
    </div>
    
    <!-- PWA Install Button -->
    <button class="install-button" id="installButton">
        <i class="fas fa-download"></i> Cài App
    </button>
    
    <!-- Back to App Button (for account management page) -->
    <button class="back-to-app" id="backToAppButton" style="display: none;">
        <i class="fas fa-arrow-left"></i> Quay lại
    </button>
    
    <!-- User Menu -->
    <div class="user-menu" id="userMenu" style="display: none;">
        <button class="user-button" id="userButton">
            <div class="user-avatar" id="userAvatar">
                <!-- Avatar image or placeholder will be inserted here -->
            </div>
            <span id="userName">Tài khoản</span>
            <i class="fas fa-chevron-down"></i>
        </button>
        <div class="user-dropdown" id="userDropdown">
            <div class="user-info">
                <div class="user-avatar" id="dropdownAvatar">
                    <!-- Avatar image or placeholder will be inserted here -->
                </div>
                <h4 id="dropdownName">Tài khoản</h4>
                <p id="dropdownEmail">user@example.com</p>
            </div>
            <button class="dropdown-item" id="manageAccountBtn">
                <i class="fas fa-user-cog"></i> Quản lý tài khoản
            </button>
            <button class="dropdown-item" id="changePasswordBtn">
                <i class="fas fa-key"></i> Đổi mật khẩu
            </button>
            <button class="dropdown-item logout" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i> Đăng xuất
            </button>
        </div>
    </div>
    
    <!-- Authentication Container -->
    <div class="container" id="authContainer">
        <div class="auth-container">
            <div class="auth-box" id="authBox">
                <!-- Login Form -->
                <div id="loginForm">
                    <h2><i class="fas fa-sign-in-alt"></i> Đăng nhập</h2>
                    <form class="auth-form" id="loginFormElement">
                        <div class="form-group">
                            <label for="loginEmail">Email hoặc tên đăng nhập</label>
                            <input type="text" id="loginEmail" placeholder="Nhập email hoặc tên đăng nhập" required>
                        </div>
                        <div class="form-group">
                            <label for="loginPassword">Mật khẩu</label>
                            <div class="password-input">
                                <input type="password" id="loginPassword" placeholder="Nhập mật khẩu" required>
                                <button type="button" class="toggle-password" data-target="loginPassword">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <div class="auth-message" id="loginMessage"></div>
                        <button type="submit" class="auth-button">
                            <i class="fas fa-sign-in-alt"></i> Đăng nhập
                        </button>
                    </form>
                    <div class="auth-links">
                        Chưa có tài khoản? <a href="#" id="showRegister">Đăng ký ngay</a>
                    </div>
                </div>
                
                <!-- Register Form -->
                <div id="registerForm" style="display: none;">
                    <h2><i class="fas fa-user-plus"></i> Đăng ký tài khoản</h2>
                    <form class="auth-form" id="registerFormElement">
                        <div class="form-group">
                            <label for="registerName">Họ và tên</label>
                            <input type="text" id="registerName" placeholder="Nhập họ và tên" required>
                        </div>
                        <div class="form-group">
                            <label for="registerEmail">Email</label>
                            <input type="email" id="registerEmail" placeholder="Nhập email" required>
                        </div>
                        <div class="form-group">
                            <label for="registerUsername">Tên đăng nhập</label>
                            <input type="text" id="registerUsername" placeholder="Nhập tên đăng nhập" required>
                        </div>
                        <div class="form-group">
                            <label for="registerPassword">Mật khẩu</label>
                            <div class="password-input">
                                <input type="password" id="registerPassword" placeholder="Nhập mật khẩu (ít nhất 6 ký tự)" required minlength="6">
                                <button type="button" class="toggle-password" data-target="registerPassword">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword">Xác nhận mật khẩu</label>
                            <div class="password-input">
                                <input type="password" id="confirmPassword" placeholder="Nhập lại mật khẩu" required minlength="6">
                                <button type="button" class="toggle-password" data-target="confirmPassword">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <div class="auth-message" id="registerMessage"></div>
                        <button type="submit" class="auth-button register">
                            <i class="fas fa-user-plus"></i> Đăng ký
                        </button>
                    </form>
                    <div class="auth-links">
                        Đã có tài khoản? <a href="#" id="showLogin">Đăng nhập</a>
                    </div>
                </div>
                
                <!-- Change Password Form -->
                <div id="changePasswordForm" style="display: none;">
                    <h2><i class="fas fa-key"></i> Đổi mật khẩu</h2>
                    <form class="auth-form" id="changePasswordFormElement">
                        <div class="form-group">
                            <label for="currentPassword">Mật khẩu hiện tại</label>
                            <div class="password-input">
                                <input type="password" id="currentPassword" placeholder="Nhập mật khẩu hiện tại" required>
                                <button type="button" class="toggle-password" data-target="currentPassword">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="newPassword">Mật khẩu mới</label>
                            <div class="password-input">
                                <input type="password" id="newPassword" placeholder="Nhập mật khẩu mới (ít nhất 6 ký tự)" required minlength="6">
                                <button type="button" class="toggle-password" data-target="newPassword">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="confirmNewPassword">Xác nhận mật khẩu mới</label>
                            <div class="password-input">
                                <input type="password" id="confirmNewPassword" placeholder="Nhập lại mật khẩu mới" required minlength="6">
                                <button type="button" class="toggle-password" data-target="confirmNewPassword">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <div class="auth-message" id="changePasswordMessage"></div>
                        <button type="submit" class="auth-button">
                            <i class="fas fa-save"></i> Cập nhật mật khẩu
                        </button>
                    </form>
                    <div class="auth-links">
                        <a href="#" id="backToAppFromChangePassword">Quay lại ứng dụng</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Account Management Page -->
    <div class="container" id="accountManagementPage" style="display: none;">
        <div class="account-management">
            <div class="account-header">
                <h2><i class="fas fa-user-cog"></i> Quản lý tài khoản</h2>
                <p>Quản lý thông tin tài khoản và cài đặt cá nhân</p>
            </div>
            
            <div class="account-sections">
                <!-- Profile Picture Section -->
                <div class="account-section">
                    <h3 class="section-title"><i class="fas fa-user-circle"></i> Ảnh đại diện</h3>
                    <div class="profile-picture-container">
                        <div class="profile-picture" id="profilePicture">
                            <!-- Profile picture will be loaded here -->
                        </div>
                        <div class="profile-picture-actions">
                            <button id="changePictureBtn">
                                <i class="fas fa-camera"></i> Thay đổi ảnh
                            </button>
                            <button id="removePictureBtn" class="btn-secondary">
                                <i class="fas fa-trash"></i> Xóa ảnh
                            </button>
                        </div>
                        <input type="file" id="pictureInput" accept="image/*" style="display: none;">
                    </div>
                </div>
                
                <!-- Personal Information Section -->
                <div class="account-section">
                    <h3 class="section-title"><i class="fas fa-id-card"></i> Thông tin cá nhân</h3>
                    <form class="account-form" id="personalInfoForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="accountName">Họ và tên</label>
                                <input type="text" id="accountName" placeholder="Nhập họ và tên" required>
                            </div>
                            <div class="form-group">
                                <label for="accountUsername">Tên đăng nhập</label>
                                <input type="text" id="accountUsername" placeholder="Nhập tên đăng nhập" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="accountEmail">Email liên kết</label>
                            <input type="email" id="accountEmail" placeholder="Nhập email" required>
                        </div>
                        <div class="account-actions">
                            <button type="button" class="btn-secondary" id="cancelPersonalInfo">
                                <i class="fas fa-times"></i> Hủy
                            </button>
                            <button type="submit" id="savePersonalInfo">
                                <i class="fas fa-save"></i> Lưu thay đổi
                            </button>
                        </div>
                        <div class="auth-message" id="personalInfoMessage"></div>
                    </form>
                </div>
                
                <!-- Change Password Section -->
                <div class="account-section">
                    <h3 class="section-title"><i class="fas fa-key"></i> Thay đổi mật khẩu</h3>
                    <form class="account-form" id="accountPasswordForm">
                        <div class="form-group">
                            <label for="accountCurrentPassword">Mật khẩu hiện tại</label>
                            <div class="password-input">
                                <input type="password" id="accountCurrentPassword" placeholder="Nhập mật khẩu hiện tại" required>
                                <button type="button" class="toggle-password" data-target="accountCurrentPassword">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="accountNewPassword">Mật khẩu mới</label>
                                <div class="password-input">
                                    <input type="password" id="accountNewPassword" placeholder="Nhập mật khẩu mới" required minlength="6">
                                    <button type="button" class="toggle-password" data-target="accountNewPassword">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="accountConfirmPassword">Xác nhận mật khẩu</label>
                                <div class="password-input">
                                    <input type="password" id="accountConfirmPassword" placeholder="Nhập lại mật khẩu mới" required minlength="6">
                                    <button type="button" class="toggle-password" data-target="accountConfirmPassword">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="account-actions">
                            <button type="button" class="btn-secondary" id="cancelPasswordChange">
                                <i class="fas fa-times"></i> Hủy
                            </button>
                            <button type="submit" id="savePasswordChange">
                                <i class="fas fa-save"></i> Đổi mật khẩu
                            </button>
                        </div>
                        <div class="auth-message" id="passwordChangeMessage"></div>
                    </form>
                </div>
                
                <!-- Danger Zone -->
                <div class="account-section">
                    <h3 class="section-title"><i class="fas fa-exclamation-triangle"></i> Khu vực nguy hiểm</h3>
                    <div class="delete-account">
                        <h4><i class="fas fa-trash"></i> Xóa tài khoản</h4>
                        <p>Hành động này không thể hoàn tác. Tất cả dữ liệu của bạn sẽ bị xóa vĩnh viễn.</p>
                        <button class="btn-danger" id="deleteAccountBtn">
                            <i class="fas fa-trash"></i> Xóa tài khoản
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main App Container -->
    <div class="container main-app" id="mainApp">
        <header>
            <h1><i class="fas fa-wallet"></i> QUẢN LÝ CHI TIÊU <span class="pwa-badge">EAP</span></h1>
            <p class="app-description">Xin chào, <span id="welcomeName">Người dùng</span>!</p>
        </header>
        
        <!-- PWA Status -->
        <div class="pwa-status" id="pwaStatus">
            <i class="fas fa-sync-alt"></i> Kiểm tra ...
        </div>
        
        <!-- PHẦN 1: TỔNG QUAN -->
        <section class="summary-section">
            <div class="summary-cards">
                <div class="card limit">
                    <h3>Giới hạn chi tiêu</h3>
                    <div class="amount limit-amount" id="limitAmount">0 đ</div>
                </div>
                
                <div class="card spent">
                    <h3>Đã chi tiêu</h3>
                    <div class="amount spent-amount" id="spentAmount">0 đ</div>
                </div>
                
                <div class="card remaining">
                    <h3>Số tiền còn lại</h3>
                    <div class="amount remaining-amount" id="remainingAmount">0 đ</div>
                </div>
            </div>
        </section>
        
        <!-- PHẦN 2: CHỨC NĂNG (TABS) -->
        <section class="functions-section">
            <div class="tab-header">
                <button class="tab-button active" data-tab="set-limit">
                    <i class="fas fa-cogs"></i> Thiết lập giới hạn
                </button>
                <button class="tab-button" data-tab="add-expense">
                    <i class="fas fa-plus-circle"></i> Thêm chi tiêu
                </button>
                <button class="tab-button" data-tab="manage-categories">
                    <i class="fas fa-edit"></i> Quản lý danh mục
                </button>
            </div>
            
            <div class="tab-content active" id="set-limit">
                <div class="input-box">
                    <h2><i class="fas fa-cogs"></i> Thiết lập giới hạn chi tiêu</h2>
                    <div class="form-group">
                        <label for="newLimit">Giới hạn chi tiêu tháng</label>
                        <input type="text" id="newLimit" placeholder="Ví dụ: 5m, 500k, 1000000" value="">
                    </div>
                    <button id="updateLimitBtn">
                        <i class="fas fa-save"></i> Cập nhật giới hạn
                    </button>
                </div>
            </div>
            
            <div class="tab-content" id="add-expense">
                <div class="input-box">
                    <h2><i class="fas fa-plus-circle"></i> Thêm khoản chi tiêu</h2>
                    <div class="form-group">
                        <label for="expenseCategory">Danh mục chi tiêu</label>
                        <select id="expenseCategory">
                            <!-- Categories will be loaded here -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="expenseAmount">Số tiền</label>
                        <input type="text" id="expenseAmount" placeholder="Ví dụ: 100k, 1.5m, 50000">
                    </div>
                    <div class="form-group">
                        <label for="expenseDate">Ngày chi tiêu</label>
                        <input type="date" id="expenseDate">
                    </div>
                    <button id="addExpenseBtn" class="btn-add">
                        <i class="fas fa-plus"></i> Thêm chi tiêu
                    </button>
                </div>
            </div>
            
            <div class="tab-content" id="manage-categories">
                <div class="edit-categories">
                    <h2><i class="fas fa-edit"></i> Quản lý danh mục chi tiêu</h2>
                    <p>Thêm, chỉnh sửa hoặc xóa các danh mục chi tiêu</p>
                    
                    <div class="categories-list" id="categoriesList">
                        <!-- Categories will be loaded here -->
                    </div>
                    
                    <div class="add-category">
                        <input type="text" id="newCategory" placeholder="Nhập tên danh mục mới">
                        <button id="addCategoryBtn" class="btn-add">
                            <i class="fas fa-plus"></i> Thêm danh mục
                        </button>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- PHẦN 3: DANH SÁCH CHI TIÊU -->
        <section class="expenses-section">
            <div class="section-header">
                <h2><i class="fas fa-list"></i> Danh sách chi tiêu trong tháng</h2>
                <div class="expenses-count" id="expensesCount">0 khoản chi</div>
            </div>
            
            <div class="expenses-table-container">
                <table class="expenses-table" id="expensesTable">
                    <thead>
                        <tr>
                            <th width="60">STT</th>
                            <th>Danh mục</th>
                            <th width="180">Số tiền</th>
                            <th width="150">Ngày</th>
                            <th width="180">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="expensesTableBody">
                        <!-- Expenses will be loaded here -->
                    </tbody>
                </table>
            </div>
        </section>
        
        <footer>
            <p>Ứng dụng Quản Lý Chi Tiêu PWA &copy; daominhduc08tb@gmail.com</p>
            <p><small><i class="fas fa-mobile-alt"></i> Có thể cài đặt như ứng dụng di động</small></p>
        </footer>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification"></div>
    
    <!-- JavaScript -->
    <script>
        // ========== AUTHENTICATION SYSTEM ==========
        let currentUser = null;
        let users = JSON.parse(localStorage.getItem('expenseManagerUsers') || '{}');
        
        // ========== USER MANAGEMENT FUNCTIONS ==========
        function showAuthForm() {
            document.getElementById('authContainer').style.display = 'block';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('userMenu').style.display = 'none';
            document.getElementById('accountManagementPage').style.display = 'none';
            document.getElementById('backToAppButton').style.display = 'none';
            showLoginForm();
        }
        
        function showMainApp() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('userMenu').style.display = 'flex';
            document.getElementById('accountManagementPage').style.display = 'none';
            document.getElementById('backToAppButton').style.display = 'none';
            updateUserUI();
            loadUserData();
        }
        
        function showAccountManagement() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('userMenu').style.display = 'none';
            document.getElementById('accountManagementPage').style.display = 'block';
            document.getElementById('backToAppButton').style.display = 'flex';
            loadAccountManagementData();
        }
        
        function showLoginForm() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('changePasswordForm').style.display = 'none';
            clearAuthMessages();
        }
        
        function showRegisterForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            document.getElementById('changePasswordForm').style.display = 'none';
            clearAuthMessages();
        }
        
        function showChangePasswordForm() {
            document.getElementById('authContainer').style.display = 'block';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('userMenu').style.display = 'none';
            document.getElementById('accountManagementPage').style.display = 'none';
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('changePasswordForm').style.display = 'block';
            clearAuthMessages();
        }
        
        function clearAuthMessages() {
            document.getElementById('loginMessage').className = 'auth-message';
            document.getElementById('registerMessage').className = 'auth-message';
            document.getElementById('changePasswordMessage').className = 'auth-message';
            document.getElementById('personalInfoMessage').className = 'auth-message';
            document.getElementById('passwordChangeMessage').className = 'auth-message';
        }
        
        function showAuthMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `auth-message ${type}`;
        }
        
        function updateUserUI() {
            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.name;
                document.getElementById('welcomeName').textContent = currentUser.name;
                document.getElementById('dropdownName').textContent = currentUser.name;
                document.getElementById('dropdownEmail').textContent = currentUser.email;
                
                // Update avatar
                updateAvatar(currentUser);
            }
        }
        
        function updateAvatar(user) {
            const avatarContainers = [
                document.getElementById('userAvatar'),
                document.getElementById('dropdownAvatar'),
                document.getElementById('profilePicture')
            ];
            
            avatarContainers.forEach(container => {
                if (!container) return;
                
                if (user.avatar) {
                    // Show image avatar
                    container.innerHTML = `<img src="${user.avatar}" class="user-avatar-img" alt="${user.name}">`;
                } else {
                    // Show placeholder with initials
                    const initials = user.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                    if (container.id === 'profilePicture') {
                        container.innerHTML = `<div class="profile-picture-placeholder">${initials}</div>`;
                    } else {
                        container.innerHTML = initials;
                    }
                }
            });
        }
        
        function login(emailOrUsername, password) {
            // Find user by email or username
            let user = null;
            for (const userId in users) {
                const u = users[userId];
                if ((u.email === emailOrUsername || u.username === emailOrUsername) && u.password === password) {
                    user = u;
                    break;
                }
            }
            
            if (user) {
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showMainApp();
                showNotification(`Chào mừng ${user.name} trở lại!`, 'success');
                return true;
            }
            
            return false;
        }
        
        function register(name, email, username, password) {
            // Check if user already exists
            for (const userId in users) {
                const user = users[userId];
                if (user.email === email) {
                    return { success: false, message: 'Email đã được sử dụng!' };
                }
                if (user.username === username) {
                    return { success: false, message: 'Tên đăng nhập đã được sử dụng!' };
                }
            }
            
            // Create new user
            const userId = Date.now().toString();
            const newUser = {
                id: userId,
                name: name,
                email: email,
                username: username,
                password: password,
                avatar: null,
                createdAt: new Date().toISOString(),
                monthlyLimit: 0,
                expenses: [],
                categories: [
                    { id: "gym", name: "Tiền tập gym" },
                    { id: "gas", name: "Tiền đổ xăng" },
                    { id: "internet", name: "Tiền mạng 4G" },
                    { id: "saving", name: "Tiền tích kiệm" },
                    { id: "haircut", name: "Tiền cắt tóc" },
                    { id: "food", name: "Ăn uống" },
                    { id: "shopping", name: "Mua sắm" }
                ]
            };
            
            users[userId] = newUser;
            localStorage.setItem('expenseManagerUsers', JSON.stringify(users));
            
            currentUser = newUser;
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            return { success: true, message: 'Đăng ký thành công!' };
        }
        
        function updatePersonalInfo(name, username, email) {
            // Check if email is being changed and if it's already used
            if (email !== currentUser.email) {
                for (const userId in users) {
                    const user = users[userId];
                    if (user.id !== currentUser.id && user.email === email) {
                        return { success: false, message: 'Email đã được sử dụng bởi tài khoản khác!' };
                    }
                }
            }
            
            // Check if username is being changed and if it's already used
            if (username !== currentUser.username) {
                for (const userId in users) {
                    const user = users[userId];
                    if (user.id !== currentUser.id && user.username === username) {
                        return { success: false, message: 'Tên đăng nhập đã được sử dụng!' };
                    }
                }
            }
            
            // Update user info
            currentUser.name = name;
            currentUser.username = username;
            currentUser.email = email;
            
            // Save changes
            users[currentUser.id] = currentUser;
            localStorage.setItem('expenseManagerUsers', JSON.stringify(users));
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            return { success: true, message: 'Cập nhật thông tin thành công!' };
        }
        
        function changePassword(currentPassword, newPassword) {
            if (currentUser.password !== currentPassword) {
                return { success: false, message: 'Mật khẩu hiện tại không đúng!' };
            }
            
            if (newPassword.length < 6) {
                return { success: false, message: 'Mật khẩu mới phải có ít nhất 6 ký tự!' };
            }
            
            currentUser.password = newPassword;
            users[currentUser.id] = currentUser;
            localStorage.setItem('expenseManagerUsers', JSON.stringify(users));
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            return { success: true, message: 'Đổi mật khẩu thành công!' };
        }
        
        function updateAvatarImage(imageDataUrl) {
            currentUser.avatar = imageDataUrl;
            users[currentUser.id] = currentUser;
            localStorage.setItem('expenseManagerUsers', JSON.stringify(users));
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            updateAvatar(currentUser);
            return { success: true, message: 'Cập nhật ảnh đại diện thành công!' };
        }
        
        function removeAvatar() {
            currentUser.avatar = null;
            users[currentUser.id] = currentUser;
            localStorage.setItem('expenseManagerUsers', JSON.stringify(users));
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            updateAvatar(currentUser);
            return { success: true, message: 'Đã xóa ảnh đại diện!' };
        }
        
        function deleteAccount() {
            if (confirm("Bạn có chắc chắn muốn xóa tài khoản? Tất cả dữ liệu sẽ bị mất vĩnh viễn và không thể khôi phục!")) {
                const password = prompt("Vui lòng nhập mật khẩu để xác nhận xóa tài khoản:");
                
                if (password === currentUser.password) {
                    // Delete user data
                    delete users[currentUser.id];
                    localStorage.setItem('expenseManagerUsers', JSON.stringify(users));
                    localStorage.removeItem('currentUser');
                    
                    currentUser = null;
                    showAuthForm();
                    showNotification('Tài khoản đã được xóa thành công!', 'success');
                    return { success: true, message: 'Tài khoản đã được xóa!' };
                } else {
                    return { success: false, message: 'Mật khẩu không đúng!' };
                }
            }
            return { success: false, message: 'Hủy xóa tài khoản!' };
        }
        
        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            monthlyLimit = 0;
            expenses = [];
            categories = [];
            showAuthForm();
            showNotification('Đã đăng xuất thành công!', 'success');
        }
        
        function loadUserData() {
            if (currentUser) {
                monthlyLimit = currentUser.monthlyLimit || 0;
                expenses = currentUser.expenses || [];
                categories = currentUser.categories || [];
                updateSummary();
                renderExpensesTable();
                renderCategories();
            }
        }
        
        function loadAccountManagementData() {
            if (currentUser) {
                // Load personal info
                document.getElementById('accountName').value = currentUser.name;
                document.getElementById('accountUsername').value = currentUser.username;
                document.getElementById('accountEmail').value = currentUser.email;
                
                // Load avatar
                updateAvatar(currentUser);
                
                // Clear password fields
                document.getElementById('accountCurrentPassword').value = '';
                document.getElementById('accountNewPassword').value = '';
                document.getElementById('accountConfirmPassword').value = '';
                
                // Clear messages
                clearAuthMessages();
            }
        }
        
        function saveUserData() {
            if (currentUser) {
                currentUser.monthlyLimit = monthlyLimit;
                currentUser.expenses = expenses;
                currentUser.categories = categories;
                users[currentUser.id] = currentUser;
                localStorage.setItem('expenseManagerUsers', JSON.stringify(users));
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
            }
        }
        
        // ========== IMAGE PROCESSING ==========
        function compressImage(file, maxWidth = 400, maxHeight = 400, quality = 0.8) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        // Calculate new dimensions
                        if (width > height) {
                            if (width > maxWidth) {
                                height = Math.round((height * maxWidth) / width);
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width = Math.round((width * maxHeight) / height);
                                height = maxHeight;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Convert to data URL with compression
                        const dataUrl = canvas.toDataURL('image/jpeg', quality);
                        resolve(dataUrl);
                    };
                    
                    img.onerror = reject;
                };
                
                reader.onerror = reject;
            });
        }
        
        // ========== BIẾN TOÀN CỤC ==========
        let monthlyLimit = 0;
        let expenses = [];
        let categories = [];
        let isOnline = navigator.onLine;
        let deferredPrompt = null;
        let pendingExpenses = JSON.parse(localStorage.getItem('pendingExpenses') || '[]');
        
        // ========== PWA FUNCTIONS ==========
        // Đăng ký Service Worker
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('Service Worker đăng ký thành công:', registration);
                        updatePWAStatus('✅ Service Worker đã sẵn sàng');
                        
                        // Kiểm tra update
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    showNotification('Đã có bản cập nhật mới!', 'info');
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.error('Service Worker đăng ký thất bại:', error);
                        updatePWAStatus('❌ Service Worker thất bại');
                    });
            } else {
                updatePWAStatus('❌ Trình duyệt không hỗ trợ Service Worker');
            }
        }
        
        // Xử lý cài đặt PWA
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Hiển thị nút cài đặt
            const installButton = document.getElementById('installButton');
            installButton.classList.add('show');
            
            installButton.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    
                    if (outcome === 'accepted') {
                        showNotification('Ứng dụng đang được cài đặt...', 'success');
                        installButton.classList.remove('show');
                    }
                    deferredPrompt = null;
                }
            });
        });
        
        // Khi app đã được cài đặt
        window.addEventListener('appinstalled', () => {
            console.log('PWA đã được cài đặt');
            updatePWAStatus('✅ Ứng dụng đã được cài đặt');
            document.getElementById('installButton').classList.remove('show');
            showNotification('Cài đặt thành công! Bạn có thể mở app từ màn hình chính.', 'success');
        });
        
        // Kiểm tra trạng thái PWA
        function checkPWAStatus() {
            const status = [];
            
            // Kiểm tra display mode
            if (window.matchMedia('(display-mode: standalone)').matches) {
                status.push('✅ Đang chạy như ứng dụng');
            } else if (window.navigator.standalone) {
                status.push('✅ Đang chạy trên iOS');
            } else {
                status.push('ℹ️ Mở trên trình duyệt');
            }
            
            // Kiểm tra online/offline
            status.push(isOnline ? '✅ Đang online' : '⚠️ Đang offline');
            
            // Kiểm tra localStorage
            status.push('localStorage' in window ? '✅ Lưu trữ cục bộ' : '❌ Không hỗ trợ lưu trữ');
            
            updatePWAStatus(status.join(' • '));
        }
        
        function updatePWAStatus(message) {
            const statusElement = document.getElementById('pwaStatus');
            if (statusElement) {
                statusElement.innerHTML = `<i class="fas fa-info-circle"></i> ${message}`;
            }
        }
        
        // ========== OFFLINE SUPPORT ==========
        function updateOnlineStatus() {
            isOnline = navigator.onLine;
            const offlineIndicator = document.getElementById('offlineIndicator');
            
            if (!isOnline) {
                offlineIndicator.classList.add('show');
                showNotification('Đang offline. Dữ liệu sẽ được lưu tạm.', 'warning');
            } else {
                offlineIndicator.classList.remove('show');
                // Đồng bộ dữ liệu chờ khi online lại
                syncPendingExpenses();
            }
            checkPWAStatus();
        }
        
        function syncPendingExpenses() {
            if (pendingExpenses.length > 0 && isOnline) {
                pendingExpenses.forEach(expense => {
                    expenses.push(expense);
                });
                
                const count = pendingExpenses.length;
                pendingExpenses = [];
                localStorage.removeItem('pendingExpenses');
                
                renderExpensesTable();
                updateSummary();
                showNotification(`Đã đồng bộ ${count} khoản chi tiêu chờ, 'success'`);
            }
        }
        
        // ========== UTILITY FUNCTIONS ==========
        function parseMoneyFormat(input) {
            if (!input || input.trim() === '') return 0;
            
            let str = input.trim().toLowerCase().replace(/\s+/g, '');
            let multiplier = 1;
            
            if (str.includes('m')) {
                multiplier = 1000000;
                str = str.replace('m', '');
            } else if (str.includes('k')) {
                multiplier = 1000;
                str = str.replace('k', '');
            } else if (str.includes('tr')) {
                multiplier = 1000000;
                str = str.replace('tr', '');
            }
            
            str = str.replace(/\./g, '').replace(/,/g, '');
            const number = parseFloat(str);
            
            return isNaN(number) ? 0 : Math.round(number * multiplier);
        }
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', { 
                style: 'currency', 
                currency: 'VND',
                minimumFractionDigits: 0
            }).format(amount);
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN');
        }
        
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // ========== CORE APP FUNCTIONS ==========
        function updateSummary() {
            const totalSpent = expenses.reduce((total, expense) => total + expense.amount, 0);
            const remaining = monthlyLimit - totalSpent;
            
            document.getElementById('limitAmount').textContent = formatCurrency(monthlyLimit);
            document.getElementById('spentAmount').textContent = formatCurrency(totalSpent);
            document.getElementById('remainingAmount').textContent = formatCurrency(remaining);
            document.getElementById('expensesCount').textContent = `${expenses.length} khoản chi`;
            
            const remainingElement = document.getElementById('remainingAmount');
            remainingElement.style.color = remaining < 0 ? '#e74c3c' : '#2ecc71';
            
            saveUserData();
        }
        
        function renderExpensesTable() {
            const tbody = document.getElementById('expensesTableBody');
            
            if (expenses.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="no-expenses">
                            <i class="fas fa-clipboard-list"></i>
                            <p>Chưa có khoản chi tiêu nào. Hãy thêm chi tiêu đầu tiên của bạn!</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            expenses.forEach((expense, index) => {
                const categoryIcon = getCategoryIcon(expense.category);
                
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>
                            <div class="category-cell">
                                <div class="category-icon">
                                    <i class="${categoryIcon}"></i>
                                </div>
                                <span>${expense.categoryName}</span>
                            </div>
                        </td>
                        <td class="amount-cell">${formatCurrency(expense.amount)}</td>
                        <td class="date-cell">${formatDate(expense.date)}</td>
                        <td>
                            <div class="actions">
                                <button class="btn-edit" onclick="editExpense(${expense.id})">
                                    <i class="fas fa-edit"></i> Sửa
                                </button>
                                <button class="btn-delete" onclick="deleteExpense(${expense.id})">
                                    <i class="fas fa-trash"></i> Xóa
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        function getCategoryIcon(categoryId) {
            const iconMap = {
                'gym': 'fas fa-dumbbell',
                'gas': 'fas fa-gas-pump',
                'internet': 'fas fa-wifi',
                'saving': 'fas fa-piggy-bank',
                'haircut': 'fas fa-cut',
                'food': 'fas fa-utensils',
                'shopping': 'fas fa-shopping-bag',
                'transport': 'fas fa-bus',
                'entertainment': 'fas fa-film',
                'health': 'fas fa-heartbeat',
                'education': 'fas fa-graduation-cap',
                'other': 'fas fa-ellipsis-h'
            };
            
            return iconMap[categoryId] || 'fas fa-tag';
        }
        
        function renderCategories() {
            const categoriesList = document.getElementById('categoriesList');
            
            let html = '';
            categories.forEach(category => {
                html += `
                    <div class="category-tag">
                        <span>${category.name}</span>
                        <i class="fas fa-times" onclick="deleteCategory('${category.id}')"></i>
                    </div>
                `;
            });
            
            categoriesList.innerHTML = html;
            updateCategoryDropdown();
        }
        
        function updateCategoryDropdown() {
            const dropdown = document.getElementById('expenseCategory');
            dropdown.innerHTML = '';
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                dropdown.appendChild(option);
            });
        }
        
        // ========== EVENT HANDLERS ==========
        function deleteExpense(id) {
            if (confirm("Bạn có chắc chắn muốn xóa khoản chi tiêu này?")) {
                expenses = expenses.filter(expense => expense.id !== id);
                renderExpensesTable();
                updateSummary();
                showNotification("Đã xóa khoản chi tiêu!", "success");
            }
        }
        
        function editExpense(id) {
            const expense = expenses.find(e => e.id === id);
            if (!expense) return;
            
            const newAmount = prompt(`Sửa số tiền cho "${expense.categoryName}":, expense.amount`);
            if (newAmount) {
                const parsedAmount = parseMoneyFormat(newAmount);
                if (parsedAmount > 0) {
                    expense.amount = parsedAmount;
                    renderExpensesTable();
                    updateSummary();
                    showNotification("Đã cập nhật khoản chi tiêu!", "success");
                } else {
                    showNotification("Số tiền không hợp lệ!", "error");
                }
            }
        }
        
        function deleteCategory(id) {
            const isUsed = expenses.some(expense => expense.category === id);
            
            if (isUsed) {
                showNotification("Không thể xóa vì có chi tiêu thuộc danh mục này!", "error");
                return;
            }
            
            if (confirm("Bạn có chắc muốn xóa danh mục này?")) {
                categories = categories.filter(cat => cat.id !== id);
                renderCategories();
                showNotification("Đã xóa danh mục!", "success");
            }
        }
        
        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', function() {
            // Thiết lập ngày mặc định
            const today = new Date();
            document.getElementById('expenseDate').value = today.toISOString().split('T')[0];
            
            // Khởi tạo PWA
            registerServiceWorker();
            checkPWAStatus();
            updateOnlineStatus();
            
            // Kiểm tra đăng nhập
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    // Tải lại thông tin người dùng từ users database
                    if (users[currentUser.id]) {
                        currentUser = users[currentUser.id];
                        showMainApp();
                    } else {
                        showAuthForm();
                    }
                } catch (error) {
                    showAuthForm();
                }
            } else {
                showAuthForm();
            }
            
            // Xử lý chuyển tab
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // Cập nhật giới hạn
            document.getElementById('updateLimitBtn').addEventListener('click', function() {
                const limitInput = document.getElementById('newLimit').value.trim();
                
                if (limitInput === '') {
                    monthlyLimit = 0;
                    updateSummary();
                    showNotification("Đã đặt giới hạn về 0!", "success");
                    return;
                }
                
                const newLimit = parseMoneyFormat(limitInput);
                
                if (newLimit >= 0) {
                    monthlyLimit = newLimit;
                    updateSummary();
                    document.getElementById('newLimit').value = '';
                    showNotification("Cập nhật giới hạn thành công!", "success");
                } else {
                    showNotification("Vui lòng nhập số tiền hợp lệ!", "error");
                }
            });
            
            // Thêm chi tiêu
            document.getElementById('addExpenseBtn').addEventListener('click', function() {
                const category = document.getElementById('expenseCategory').value;
                const amountInput = document.getElementById('expenseAmount').value.trim();
                const date = document.getElementById('expenseDate').value;
                
                if (!category || !amountInput || !date) {
                    showNotification("Vui lòng điền đầy đủ thông tin!", "error");
                    return;
                }
                
                const amount = parseMoneyFormat(amountInput);
                
                if (amount <= 0) {
                    showNotification("Số tiền phải lớn hơn 0!", "error");
                    return;
                }
                
                const categoryObj = categories.find(cat => cat.id === category);
                const categoryName = categoryObj ? categoryObj.name : category;
                const newId = expenses.length > 0 ? Math.max(...expenses.map(e => e.id)) + 1 : 1;
                
                const newExpense = {
                    id: newId,
                    category: category,
                    categoryName: categoryName,
                    amount: amount,
                    date: date
                };
                
                // Xử lý offline
                if (!isOnline) {
                    pendingExpenses.push({
                        ...newExpense,
                        pending: true,
                        timestamp: new Date().toISOString()
                    });
                    localStorage.setItem('pendingExpenses', JSON.stringify(pendingExpenses));
                    showNotification('Đã lưu tạm. Sẽ đồng bộ khi có mạng.', 'warning');
                    document.getElementById('expenseAmount').value = '';
                    return;
                }
                
                expenses.push(newExpense);
                renderExpensesTable();
                updateSummary();
                showNotification("Đã thêm chi tiêu mới!", "success");
                document.getElementById('expenseAmount').value = '';
            });
            
            // Thêm danh mục
            document.getElementById('addCategoryBtn').addEventListener('click', function() {
                const newCategoryName = document.getElementById('newCategory').value.trim();
                
                if (!newCategoryName) {
                    showNotification("Vui lòng nhập tên danh mục!", "error");
                    return;
                }
                
                const newCategoryId = newCategoryName.toLowerCase()
                    .replace(/\s+/g, '_')
                    .replace(/[^a-z0-9_]/g, '');
                
                if (categories.find(cat => cat.id === newCategoryId || cat.name === newCategoryName)) {
                    showNotification("Danh mục đã tồn tại!", "error");
                    return;
                }
                
                categories.push({
                    id: newCategoryId,
                    name: newCategoryName
                });
                
                renderCategories();
                showNotification("Đã thêm danh mục mới!", "success");
                document.getElementById('newCategory').value = '';
            });
            
            // ========== AUTHENTICATION EVENT HANDLERS ==========
            
            // Đăng nhập form
            document.getElementById('loginFormElement').addEventListener('submit', function(e) {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value.trim();
                const password = document.getElementById('loginPassword').value;
                
                if (login(email, password)) {
                    showMainApp();
                } else {
                    showAuthMessage('loginMessage', 'Email/username hoặc mật khẩu không đúng!', 'error');
                }
            });
            
            // Đăng ký form
            document.getElementById('registerFormElement').addEventListener('submit', function(e) {
                e.preventDefault();
                const name = document.getElementById('registerName').value.trim();
                const email = document.getElementById('registerEmail').value.trim();
                const username = document.getElementById('registerUsername').value.trim();
                const password = document.getElementById('registerPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                // Validation
                if (password !== confirmPassword) {
                    showAuthMessage('registerMessage', 'Mật khẩu xác nhận không khớp!', 'error');
                    return;
                }
                
                if (password.length < 6) {
                    showAuthMessage('registerMessage', 'Mật khẩu phải có ít nhất 6 ký tự!', 'error');
                    return;
                }
                
                const result = register(name, email, username, password);
                if (result.success) {
                    showAuthMessage('registerMessage', result.message, 'success');
                    setTimeout(() => {
                        showMainApp();
                    }, 1500);
                } else {
                    showAuthMessage('registerMessage', result.message, 'error');
                }
            });
            
            // Đổi mật khẩu form
            document.getElementById('changePasswordFormElement').addEventListener('submit', function(e) {
                e.preventDefault();
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmNewPassword = document.getElementById('confirmNewPassword').value;
                
                if (newPassword !== confirmNewPassword) {
                    showAuthMessage('changePasswordMessage', 'Mật khẩu xác nhận không khớp!', 'error');
                    return;
                }
                
                const result = changePassword(currentPassword, newPassword);
                if (result.success) {
                    showAuthMessage('changePasswordMessage', result.message, 'success');
                    setTimeout(() => {
                        showMainApp();
                    }, 1500);
                } else {
                    showAuthMessage('changePasswordMessage', result.message, 'error');
                }
            });
            
            // ========== ACCOUNT MANAGEMENT EVENT HANDLERS ==========
            
            // Personal info form
            document.getElementById('personalInfoForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const name = document.getElementById('accountName').value.trim();
                const username = document.getElementById('accountUsername').value.trim();
                const email = document.getElementById('accountEmail').value.trim();
                
                const result = updatePersonalInfo(name, username, email);
                if (result.success) {
                    showAuthMessage('personalInfoMessage', result.message, 'success');
                    updateUserUI();
                    setTimeout(() => {
                        showMainApp();
                    }, 1500);
                } else {
                    showAuthMessage('personalInfoMessage', result.message, 'error');
                }
            });
            
            // Cancel personal info changes
            document.getElementById('cancelPersonalInfo').addEventListener('click', function() {
                loadAccountManagementData();
                showAuthMessage('personalInfoMessage', 'Đã hủy thay đổi!', 'info');
            });
            
            // Password change form
            document.getElementById('accountPasswordForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const currentPassword = document.getElementById('accountCurrentPassword').value;
                const newPassword = document.getElementById('accountNewPassword').value;
                const confirmPassword = document.getElementById('accountConfirmPassword').value;
                
                if (newPassword !== confirmPassword) {
                    showAuthMessage('passwordChangeMessage', 'Mật khẩu xác nhận không khớp!', 'error');
                    return;
                }
                
                const result = changePassword(currentPassword, newPassword);
                if (result.success) {
                    showAuthMessage('passwordChangeMessage', result.message, 'success');
                    setTimeout(() => {
                        showMainApp();
                    }, 1500);
                } else {
                    showAuthMessage('passwordChangeMessage', result.message, 'error');
                }
            });
            
            // Cancel password change
            document.getElementById('cancelPasswordChange').addEventListener('click', function() {
                loadAccountManagementData();
                showAuthMessage('passwordChangeMessage', 'Đã hủy thay đổi!', 'info');
            });
            
            // Change profile picture
            document.getElementById('changePictureBtn').addEventListener('click', function() {
                document.getElementById('pictureInput').click();
            });
            
            document.getElementById('pictureInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    if (!file.type.startsWith('image/')) {
                        showNotification('Vui lòng chọn file hình ảnh!', 'error');
                        return;
                    }
                    
                    if (file.size > 5 * 1024 * 1024) {
                        showNotification('Kích thước file quá lớn (tối đa 5MB)!', 'error');
                        return;
                    }
                    
                    // Compress and update avatar
                    compressImage(file)
                        .then(compressedImage => {
                            const result = updateAvatarImage(compressedImage);
                            showNotification(result.message, 'success');
                        })
                        .catch(error => {
                            showNotification('Có lỗi xảy ra khi xử lý ảnh!', 'error');
                            console.error('Image processing error:', error);
                        });
                    
                    // Reset file input
                    e.target.value = '';
                }
            });
            
            // Remove profile picture
            document.getElementById('removePictureBtn').addEventListener('click', function() {
                const result = removeAvatar();
                showNotification(result.message, 'success');
            });
            
            // Delete account
            document.getElementById('deleteAccountBtn').addEventListener('click', function() {
                const result = deleteAccount();
                if (!result.success && result.message !== 'Hủy xóa tài khoản!') {
                    showNotification(result.message, 'error');
                }
            });
            
            // ========== NAVIGATION EVENT HANDLERS ==========
            
            // Toggle password visibility
            document.querySelectorAll('.toggle-password').forEach(button => {
                button.addEventListener('click', function() {
                    const targetId = this.getAttribute('data-target');
                    const input = document.getElementById(targetId);
                    const icon = this.querySelector('i');
                    
                    if (input.type === 'password') {
                        input.type = 'text';
                        icon.className = 'fas fa-eye-slash';
                    } else {
                        input.type = 'password';
                        icon.className = 'fas fa-eye';
                    }
                });
            });
            
            // Chuyển đổi giữa login và register
            document.getElementById('showRegister').addEventListener('click', function(e) {
                e.preventDefault();
                showRegisterForm();
            });
            
            document.getElementById('showLogin').addEventListener('click', function(e) {
                e.preventDefault();
                showLoginForm();
            });
            
            document.getElementById('backToAppFromChangePassword').addEventListener('click', function(e) {
                e.preventDefault();
                showMainApp();
            });
            
            // Back to app button
            document.getElementById('backToAppButton').addEventListener('click', function() {
                showMainApp();
            });
            
            // User menu dropdown
            document.getElementById('userButton').addEventListener('click', function() {
                document.getElementById('userDropdown').classList.toggle('show');
            });
            
            document.getElementById('manageAccountBtn').addEventListener('click', function() {
                document.getElementById('userDropdown').classList.remove('show');
                showAccountManagement();
            });
            
            document.getElementById('changePasswordBtn').addEventListener('click', function() {
                document.getElementById('userDropdown').classList.remove('show');
                showChangePasswordForm();
            });
            
            document.getElementById('logoutBtn').addEventListener('click', function() {
                document.getElementById('userDropdown').classList.remove('show');
                logout();
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(event) {
                const userMenu = document.getElementById('userMenu');
                const userButton = document.getElementById('userButton');
                const userDropdown = document.getElementById('userDropdown');
                
                if (userMenu && userButton && userDropdown && 
                    !userMenu.contains(event.target) && userDropdown.classList.contains('show')) {
                    userDropdown.classList.remove('show');
                }
            });
            
            showNotification("Ứng dụng đã sẵn sàng!", "success");
        });
        
        // ========== EVENT LISTENERS ==========
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        window.addEventListener('beforeunload', saveUserData);
        
        // Kiểm tra PWA định kỳ
        setInterval(checkPWAStatus, 60000);
    </script>
</body>
</html>
